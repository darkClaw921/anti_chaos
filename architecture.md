# Архитектура проекта АнтиChaos Telegram Mini App

## Общее описание

Telegram Mini App для саморазвития, который помогает пользователям отслеживать прогресс в различных сферах жизни через ежедневные вопросы и визуализацию прогресса.

## Структура проекта

### Docker конфигурация:
- `docker-compose.yml` - оркестрация всех сервисов (backend, frontend, bot)
- `backend/Dockerfile` - образ для backend сервиса
- `frontend/Dockerfile` - образ для frontend сервиса (многоэтапная сборка с nginx для production)
- `frontend/nginx.conf` - конфигурация nginx для раздачи статики и проксирования API запросов к backend
- `bot/Dockerfile` - образ для Telegram бота
- `.dockerignore` - исключения для Docker сборки

### Frontend (`frontend/`)

Веб-приложение на React, работающее внутри Telegram через WebView.

#### Основные файлы:
- `public/index.html` - главная HTML страница
- `src/index.jsx` - точка входа приложения
- `src/App.jsx` - главный компонент с роутингом

#### Компоненты (`src/components/`):
- `WelcomeScreen.jsx` - экран приветствия (Экран 01, проверяет статус онбординга при загрузке и редиректит на `/daily`, если онбординг завершен)
- `FormatExplanation.jsx` - объяснение формата работы (Экран 02)
- `SphereRating.jsx` - оценка сфер жизни (Экран 03, оценка идет цифрами от 1 до 10)
- `SphereSelection.jsx` - выбор фокус-сфер (Экран 04)
- `SpiderChart.jsx` - отображение паутинки прогресса (Экран 05)
- `DailyQuestion.jsx` - вопрос дня с формой ответа (Экраны 06-07, объединены в один экран: вопрос, поле ввода ответа и кнопка "Отправить ответ" на одном экране, кнопки "Пропустить", "Пропустить все вопросы сегодня", "Не понял вопроса" с логикой счетчиков, при втором пропуске если выбраны 2 сферы переключается на вопросы из второй сферы, отслеживает текущую сферу через `currentSphereIndex` и передает её в API запрос)
- `Layout.jsx` - компонент-обертка для всех маршрутов, содержит кнопку меню-сэндвич
- `MenuButton.jsx` - кнопка меню-сэндвич, всегда видимая на всех экранах в правом верхнем углу
- `Confirmation.jsx` - подтверждение ответа (Экран 08)
- `MiniReward.jsx` - мини-награда (Экран 09)
- `DailySummary.jsx` - итоги дня (Экран 10, без кнопки "Посмотреть прогресс")
- `Progress.jsx` - прогресс за период (Экран 11, без кнопки "Итоги недели", показывается только после полной цифровой оценки всех сфер)
- `WeeklySummary.jsx` - итоги недели (Экран 12)
- `MonthlyReport.jsx` - месячный отчёт (Экран 13, отображает радарный график с двумя полигонами "Было" и "Стало", легенду под графиком, секцию активных сфер с описанием, секции выросших и просевших сфер с цветными прогресс-барами, кнопку "Поделиться результатом", кнопку "Пошаговый план улучшения (платно)" которая ведет на экран пресейла)
- `ImprovementPlanPresale.jsx` - пресейл перед тарифом (Экран 23, отображает динамический заголовок с названием первой фокус-сферы пользователя, динамическое количество ответов из месячного отчёта, список преимуществ платного плана улучшения, информацию о платной функции, отзыв пользователя, кнопки "Назад" и "Посмотреть тарифы" которая ведет на экран подписки)
- `Subscription.jsx` - экран подписки (Экран 24, отображает три тарифа: FREE с ограничениями и возможностями, PRO с полным функционалом за 299 Р/мес, Личная консультация за 4999 P, точки пагинации, кнопки "Назад" и "Выбрать" для выбора тарифа, поддерживает свайп для переключения между тарифами, после выбора тарифа переходит на экран подтверждения)
- `SubscriptionSuccess.jsx` - экран подтверждения подписки (Экран 25, отображает заголовок "Подписка оформлена!", текст поздравления, кнопки "Выйти" и "Посмотреть итоги недели" которая ведет на экран анализа текущей ситуации)
- `SituationAnalysis.jsx` - экран анализа текущей ситуации (Экран 26, отображает заголовок "АНАЛИЗ ТЕКУЩЕЙ СИТУАЦИИ", динамическое количество ответов из месячного отчёта, показатели сферы с прогресс-барами текущих и целевых значений, выявленные паттерны, фазу 1 с целью и детальными шагами, раздел "Почему это первый шаг?", метрику успеха, кнопки "Назад" и "Скопировать информацию" для копирования плана в буфер обмена)
- `Menu.jsx` - главное меню (Экран 18, для гостевых пользователей отображается кнопка "Сгенерировать все тестовые данные")
- `Account.jsx` - профиль пользователя (Экран 19, содержит только имя, пол и дату рождения, без времени уведомлений)
- `Settings.jsx` - настройки (Экран 20, включает параметр "Тестовые уведомления" только для админов, содержит кнопку для изменения оценок сфер жизни, для админов содержит раздел "Админ-панель" с кнопками "База вопросов" и "Управление сферами")
- `ChangeFocusSpheres.jsx` - смена фокус-сфер (Экран 21, проверяет возможность изменения фокус-сфер перед загрузкой и сохранением, блокирует выбор если не все вопросы по текущим сферам отвечены за период с момента последнего изменения, сортирует сферы по оценкам пользователя по возрастанию, сферы без оценок отображаются в конце списка)
- `EditSphereRating.jsx` - редактирование оценок сфер жизни (доступно из настроек)
- `ReturnAfterPause.jsx` - возврат после паузы (Экран 16)
- `SimpleQuestion.jsx` - упрощённый вопрос (Экран 17)
- `QuestionDatabase.jsx` - база вопросов для админов (Экран 22)
- `SphereManagement.jsx` - управление сферами жизни для админов (добавление, редактирование, удаление сфер)
- `Button.jsx` - переиспользуемый компонент кнопки

#### Сервисы (`src/services/`):
- `api.js` - HTTP клиент для работы с backend API (поддерживает Telegram и гостевой режим, сохраняет guest_user_id в localStorage, включает методы для админов: `checkIsAdmin`, `getAllQuestions`, `createQuestion`, `updateQuestion`, `deleteQuestion`, методы для управления сферами: `getAllSpheres`, `createSphere`, `updateSphere`, `deleteSphere`, метод `deleteAccount` для удаления аккаунта, метод `checkOnboardingStatus` для проверки статуса онбординга, метод `getDailyQuestion` принимает параметр `currentSphere` для указания текущей сферы при запросе вопроса, метод `canChangeFocusSpheres` для проверки возможности изменения фокус-сфер, метод `generateTestData` для генерации тестовых данных для гостевых пользователей)
- `telegram.js` - интеграция с Telegram Web App API (все функции проверяют наличие Telegram и работают без него)

#### Утилиты (`src/utils/`):
- `constants.js` - константы приложения (сферы жизни, цвета)
- `chart.js` - утилиты для работы с графиками (функция `prepareSpiderChartData` для подготовки данных одного графика, функция `prepareSpiderChartDataComparison` для подготовки данных графика сравнения "Было/Стало", функция `getSpiderChartOptions` с поддержкой отображения легенды)

#### Стили (`src/styles/`):
- `main.css` - основные стили приложения
- `components.css` - стили компонентов

### Backend (`backend/`)

FastAPI приложение, предоставляющее REST API для фронтенда.

#### Основные файлы:
- `main.py` - точка входа FastAPI приложения (использует `lifespan` context manager для управления жизненным циклом, автоматически создает таблицы БД при старте через `Base.metadata.create_all`, выполняет миграции, создает вопросы по умолчанию, включает логирование для диагностики)
- `config.py` - конфигурация приложения (обрабатывает относительные пути к БД и преобразует их в абсолютные относительно корня проекта через валидатор `normalize_database_url`, создает директорию для БД если её нет, включает логирование для диагностики)

#### API endpoints (`api/`):
- `users.py` - endpoints для работы с пользователями (поддерживает Telegram и гостевой режим через `get_current_user`, получает IP адрес из заголовков запроса для гостевого режима, ищет существующего гостя по IP или создаёт нового с тестовыми данными, включает проверку админа через `get_admin_user` и endpoint `/api/users/is-admin`, endpoint `DELETE /api/users/me` для удаления аккаунта, endpoint `GET /api/users/onboarding-status` для проверки статуса онбординга, endpoint `POST /api/users/me/generate-test-data` для генерации тестовых данных для гостевых пользователей)
- `questions.py` - endpoints для работы с вопросами (включает админские endpoints `/api/questions/admin/*` для CRUD операций, endpoint `GET /api/questions/spheres-for-rating` для получения сфер для оценки после окончания вопросов, endpoint `GET /api/questions/daily` принимает параметр `current_sphere` для указания текущей сферы при работе с вопросами)
- `answers.py` - endpoints для работы с ответами
- `progress.py` - endpoints для получения прогресса
- `settings.py` - endpoints для настроек пользователя (включает поддержку параметра `admin_test_notifications` только для админов)
- `spheres.py` - endpoints для работы со сферами жизни (endpoint `GET /api/spheres/for-rating-after-questions` для получения сфер для оценки после окончания вопросов, endpoint `GET /api/spheres/focus/can-change` для проверки возможности изменения фокус-сфер, endpoint `PUT /api/spheres/focus` проверяет возможность изменения перед сохранением и возвращает ошибку 400 если не все вопросы по текущим сферам отвечены за период с момента последнего изменения, админские endpoints `/api/spheres/admin/*` для CRUD операций со сферами: `GET /api/spheres/admin/all`, `POST /api/spheres/admin/`, `PUT /api/spheres/admin/{sphere_id}`, `DELETE /api/spheres/admin/{sphere_id}`)

#### База данных (`database/`):
- `database.py` - подключение к БД и сессии
- `models.py` - модели данных SQLAlchemy:
  - `User` - пользователи (telegram_id может быть отрицательным для гостевых пользователей, ip_address хранит IP адрес для гостей)
  - `UserSphere` - оценки сфер пользователя (оценка идет цифрами от 1 до 10)
  - `Sphere` - определения сфер жизни (ключ, название, цвет)
  - `Question` - вопросы
  - `Answer` - ответы пользователей
  - `UserFocusSphere` - выбранные фокус-сферы
  - `Subscription` - подписки пользователей
  - `UserSettings` - настройки пользователей
  - `QuestionSchedule` - расписание вопросов (заглушка, позже будет заполнена списком вопросов для каждого дня)
- `crud.py` - CRUD операции для всех моделей (включая `get_user_by_id` для гостевого режима, `get_user_by_ip` для поиска гостя по IP адресу, `create_guest_user_with_test_data` для создания гостя с тестовыми данными - создаёт оценки всех сфер, фокус-сферы и тестовые ответы на вопросы, функция `generate_test_data_for_user` для генерации тестовых данных для существующего пользователя - удаляет существующие данные и создаёт новые тестовые данные, функции для управления вопросами: `get_all_questions`, `create_question`, `update_question`, `delete_question`, `get_random_question_by_sphere` - получает случайный вопрос по сфере, принимает опциональный параметр `since_date` для фильтрации вопросов по дате начала периода, если указан, не возвращает вопросы на которые пользователь уже ответил за этот период, если не указан, проверяет только ответы за сегодня, функции для управления сферами: `get_all_spheres`, `get_sphere_by_key`, `create_sphere`, `update_sphere`, `delete_sphere` - при удалении сферы каскадно удаляются все связанные данные: оценки сфер пользователей (`user_spheres`), фокус-сферы пользователей (`user_focus_spheres`), записи расписания вопросов (`question_schedule`), вопросы (`questions`) и связанные ответы, функция `delete_user_account` для удаления всех данных пользователя, функция `has_user_answered_today` для проверки, ответил ли пользователь сегодня на вопрос, поддержка параметра `admin_test_notifications` в `update_user_settings`, функция `check_onboarding_completed` для проверки завершения онбординга - проверяет наличие оценок всех сфер из базы данных и хотя бы одной фокус-сферы, функция `can_change_focus_spheres` для проверки возможности изменения фокус-сфер - проверяет, что все активные вопросы по текущим фокус-сферам отвечены за период с момента последнего изменения фокус-сфер, заглушки для работы с расписанием вопросов: `get_questions_from_schedule`, `create_question_schedule_entry`)

#### Сервисы (`services/`):
- `telegram_auth.py` - проверка авторизации через Telegram Web App API
- `question_service.py` - бизнес-логика работы с вопросами (логика работы с расписанием вопросов - вопросы идут из расписания рандомно, если выбрана 1 фокус-сфера - вопросы только из этой сферы, если выбраны 2 фокус-сферы - сначала все вопросы из первой сферы, потом все из второй, функция `get_daily_question_for_user` принимает параметр `current_sphere` для указания текущей сферы при работе с вопросами, не показывает вопросы на которые пользователь уже ответил за период с момента последнего изменения фокус-сфер, функция `get_spheres_for_rating_after_questions` для определения сфер для оценки после окончания вопросов)
- `progress_service.py` - расчёт прогресса пользователя

### Bot (`bot/`)

Telegram бот для запуска Mini App и отправки уведомлений пользователям.

#### Файлы:
- `bot.py` - основной код бота с командой /start и запуском сервиса уведомлений
- `config.py` - конфигурация бота

#### Сервисы (`services/`):
- `notification_service.py` - сервис для отправки уведомлений пользователям о необходимости ответить на вопросы (проверяет настройки пользователя, время уведомления, статус паузы, отправляет уведомления только пользователям с положительным telegram_id, которые еще не ответили сегодня)

## Технологии

### Frontend:
- React 18
- React Router DOM 6
- Chart.js + react-chartjs-2 для графиков
- Vite для сборки
- Telegram Web App API для интеграции с Telegram

### Backend:
- Python 3.12+
- FastAPI для REST API
- SQLAlchemy для работы с БД
- aiosqlite для асинхронной работы с SQLite
- Pydantic для валидации данных
- python-telegram-bot для Telegram бота
- uv для управления зависимостями

### Инфраструктура:
- Docker и Docker Compose для контейнеризации
- Многоэтапная сборка для оптимизации образов

## База данных

Используется SQLite (можно заменить на PostgreSQL).

### Таблицы:
1. `users` - пользователи (telegram_id, username, first_name, last_name, name, gender, birth_date, created_at, ip_address)
2. `user_spheres` - оценки сфер (user_id, sphere, rating от 1 до 10, date)
3. `questions` - база вопросов (id, sphere, text, type, is_active)
4. `answers` - ответы пользователей (user_id, question_id, answer, date)
5. `user_focus_spheres` - фокус-сферы (user_id, sphere, selected_at)
6. `subscriptions` - подписки (user_id, plan, expires_at)
7. `user_settings` - настройки (user_id, notification_time, language, is_paused, admin_test_notifications)
8. `question_schedule` - расписание вопросов (id, day_number, question_id, sphere, created_at) - заглушка, позже будет заполнена
9. `spheres` - определения сфер жизни (id, key, name, color, created_at, updated_at)

## Поток данных

1. Пользователь открывает Mini App через Telegram бота
2. Frontend получает initData от Telegram Web App API
3. Frontend отправляет запросы к Backend API с initData в заголовках
4. Backend проверяет initData через `telegram_auth.py`
5. Backend выполняет операции с БД через SQLAlchemy
6. Backend возвращает данные в формате JSON
7. Frontend отображает данные пользователю

## Авторизация

Приложение поддерживает два режима авторизации:

### Режим Telegram (основной)
- Frontend получает `initData` от Telegram Web App API
- `initData` передаётся в заголовке `X-Telegram-Init-Data` при каждом запросе
- Backend проверяет подпись `initData` используя секретный ключ бота
- Из `initData` извлекается `telegram_id` пользователя
- Пользователь создаётся автоматически при первом обращении

### Гостевой режим (без Telegram)
- Если `initData` отсутствует, используется гостевой режим
- Frontend сохраняет `guest_user_id` в localStorage после первого запроса
- `guest_user_id` передаётся в заголовке `X-Guest-User-Id` при каждом запросе
- Backend получает IP адрес клиента из заголовков запроса (`X-Real-IP` → `X-Forwarded-For` → `request.client.host`)
- Backend ищет существующего гостевого пользователя по IP адресу (только пользователи с отрицательным `telegram_id`)
- Если гость найден по IP, возвращается существующий пользователь
- Если гость не найден, создаётся новый гостевой пользователь с тестовыми данными:
  - Оценки всех сфер жизни (случайные значения от 5 до 8)
  - Выбор 1-2 фокус-сфер (случайно из всех сфер)
  - Несколько тестовых ответов на вопросы (5-10 ответов за последние 3-7 дней)
  - Настройки пользователя по умолчанию
- IP адрес сохраняется в поле `ip_address` модели `User` для гостевых пользователей
- Гостевые пользователи имеют username вида `guest_<telegram_id>` и имя "Гость"
- При смене IP адреса создаётся новый гостевой пользователь
- Приложение полностью функционально в гостевом режиме и может работать в обычном браузере

## Основные функции

1. **Онбординг**: оценка всех сфер жизни цифрами от 1 до 10, выбор фокус-сфер (1 или 2), показ первой паутинки
2. **Ежедневный цикл**: получение вопроса дня из расписания (рандомно), ответ на вопрос на одном экране с вопросом (поле ввода и кнопка "Отправить ответ"), кнопки "Пропустить" (максимум 2 нажатия, после 2-го появляется кнопка "Пропустить все вопросы сегодня", при втором пропуске если выбраны 2 сферы переключается на вопросы из второй сферы), "Не понял вопроса" (максимум 2 раза в день, при втором нажатии если выбраны 2 сферы переключается на вопросы из второй сферы), подтверждение, награда
3. **Логика вопросов**: если выбрана 1 фокус-сфера - вопросы только из этой сферы, если выбраны 2 фокус-сферы - сначала все вопросы из первой сферы, потом все из второй (переключение на вторую сферу происходит при втором пропуске или при втором нажатии "Не понял вопроса"); когда вопросы закончились - предлагается оценка сфер жизни (1 или 2 сферы, которые пользователь проходил за период)
4. **Прогресс**: визуализация прогресса через графики паутинки, показывается только после полной цифровой оценки всех сфер (как при онбординге), без кнопки "Итоги недели"
5. **Настройки**: изменение языка, пауза бота (время уведомлений убрано из профиля, оставлена только дата рождения)
6. **Меню**: навигация по всем функциям приложения, кнопка меню-сэндвич всегда видна на всех экранах в правом верхнем углу
7. **Админ-панель**: управление базой вопросов и управление сферами жизни (доступно только админам, указанным в ADMINS в .env; админы могут добавлять, редактировать и удалять сферы жизни через интерфейс управления сферами)
8. **Уведомления**: автоматическая отправка напоминаний пользователям о необходимости ответить на вопрос дня в указанное время (учитывает настройки notification_time и is_paused, отправляет только пользователям с положительным telegram_id, которые еще не ответили сегодня; для админов доступен параметр admin_test_notifications для получения уведомлений каждую минуту в тестовых целях)
9. **Оценка сфер**: обновление оценки сфер происходит только после полной цифровой оценки всех сфер (как при онбординге), ответы на вопросы в течение месяца предполагают текстовые ответы
10. **Управление сферами**: админы могут управлять определениями сфер жизни (ключ, название, цвет) через админ-панель в настройках; при удалении сферы каскадно удаляются все связанные данные: оценки сфер пользователей, фокус-сферы пользователей, записи расписания вопросов, вопросы и связанные ответы

## Запуск проекта

### Docker Compose (рекомендуемый способ):

Все сервисы запускаются через Docker Compose:

```bash
docker-compose up -d
```

Остановка:
```bash
docker-compose down
```

Просмотр логов:
```bash
docker-compose logs -f
```

База данных `antichaos.db` создаётся и сохраняется в корне проекта.

### Локальный запуск (без Docker):

#### Backend:
```bash
cd backend
uv sync
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

#### Frontend:
# dev server
```bash
cd frontend
npm install
npm run dev
```
# build
```bash
cd frontend
npm run build
```
# start server
```bash
cd frontend
npm run start
```

#### Bot:
```bash
uv run python bot/bot.py
```

## Миграции базы данных

Миграции находятся в `backend/database/`:
- `migrate_settings.py` - миграция для добавления новых колонок в user_settings
- `migrate_user_profile.py` - миграция для добавления полей профиля пользователя
- `migrate_spheres.py` - миграция для создания таблицы spheres и добавления начальных данных (health, relationships, money, energy, career, other, а также платные сферы: self_realization, living_conditions, personal_growth, creativity)
- `migrate_guest_ip.py` - миграция для добавления поля ip_address в таблицу users и создания индекса

## Конфигурация

Все настройки находятся в файле `.env`:
- `TELEGRAM_BOT_TOKEN` - токен Telegram бота
- `TELEGRAM_BOT_SECRET_KEY` - секретный ключ для проверки initData
- `DATABASE_URL` - URL базы данных
- `FRONTEND_URL` - URL фронтенда
- `BACKEND_URL` - URL backend API
- `ADMINS` - список telegram_id админов через запятую (например: `ADMINS=123456789,987654321`)

## Админ-панель

Админы, указанные в переменной `ADMINS` в `.env`, имеют доступ к дополнительным функциям:
- В настройках отображается раздел "Админ-панель" с кнопками "База вопросов" и "Управление сферами"
- Доступ к экрану управления базой вопросов (Экран 22)
- Возможность просматривать, добавлять, редактировать и удалять вопросы по темам (сферам)
- Фильтрация вопросов по сферам жизни
- Управление активностью вопросов (включение/выключение)
- Доступ к экрану управления сферами жизни
- Возможность добавлять, редактировать и удалять сферы жизни (ключ, название, цвет)
- При создании новой сферы указывается ключ (только латинские буквы, цифры и подчеркивания), название и цвет в формате HEX

